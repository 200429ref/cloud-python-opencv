#!/bin/bash

set -e

git submodule init
git submodule update

cd ~
sudo yum update

# Install OpenCV
sudo yum -y install cmake
sudo yum -y install gcc gcc-c++ make numpy
sudo yum -y install python-devel

sudo pip install --upgrade numpy

set +e
pkg-config --modversion opencv
opencv_installed=$?
set -e

if [[ $opencv_installed != 0 ]]; then
  echo "Installing OpenCV..."
  if [ ! -e "opencv-2.4.9.zip" ]; then
    wget http://softlayer-sng.dl.sourceforge.net/project/opencvlibrary/opencv-unix/2.4.9/opencv-2.4.9.zip
  fi

  if [ ! -e "opencv-2.4.9" ]; then
    unzip opencv-2.4.9.zip
  fi
  cd opencv-2.4.9

  if [ ! -d "release" ]; then
    mkdir release
  fi

  cd release
  cmake -D CMAKE_BUILD_TYPE=RELEASE -D CMAKE_INSTALL_PREFIX=/usr/local -D BUILD_PYTHON_SUPPORT=ON ..
  sudo make
  sudo make install

  echo "/usr/local/lib" | sudo tee /etc/ld.so.conf.d/opencv.conf

  echo "export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib" >> ~/.bash_profile
  echo "export PKG_CONFIG_PATH=$PKG_CONFIG_PATH:/usr/local/lib/pkgconfig" >> ~/.bash_profile
  echo "export PYTHONPATH=/usr/local/lib/python2.7/site-packages" >> ~/.bash_profile

  export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib
  export PKG_CONFIG_PATH=$PKG_CONFIG_PATH:/usr/local/lib/pkgconfig
fi

cd $(dirname $0)
cd py-video-retargeting

sudo pip install -r requirements
