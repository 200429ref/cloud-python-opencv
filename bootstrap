#!/bin/bash

set -e

# git submodule init
# git submodule update

sudo yum update

sudo yum -y install cmake
sudo yum -y install kernel-devel gcc gcc-c++ make automake numpy
sudo yum -y install python-devel

# Dipendences for scipy
sudo yum -y install atlas-devel lapack lapack-devel blas-devel

# Installing python 2.7
if [[ -n $(python -V 2>&1 | grep 2.6) ]]; then
  sudo yum -y install python27-devel
  sudo rm /usr/bin/python
  sudo ln -s /usr/bin/python2.7 /usr/bin/python
  # Fixing yum
  sudo sed -ri "1s/python/python2.6/" $(which yum)
  # Installing pip
  sudo yum install -y python27-pip
  sudo ln -s /usr/bin/pip-2.7 /usr/bin/pip
fi

sudo pip install --upgrade numpy

if [[ ! -d "release" ]]; then
  mkdir junk
fi
cd junk

set +e
pkg-config --modversion opencv
opencv_installed=$?
set -e

if [[ $opencv_installed != 0 ]]; then
  echo "Installing OpenCV..."

  echo "Installing Dipendences..."
  sudo yum install -y libtool make nasm pkgconfig zlib-devel

  #########################
  # Installing libav*
  #########################
  wget http://pkgs.repoforge.org/rpmforge-release/rpmforge-release-0.5.3-1.el6.rf.x86_64.rpm
  sudo rpm -ivh rpmforge-release-0.5.3-1.el6.rf.x86_64.rpm

  echo "[base]" | sudo tee /etc/yum.repos.d/CentOS-Base.repo
  echo "name=CentOS-6 - Base" | sudo tee -a /etc/yum.repos.d/CentOS-Base.repo
  echo "mirrorlist=http://mirrorlist.centos.org/?release=6&arch=x86_64&repo=os" | sudo tee -a /etc/yum.repos.d/CentOS-Base.repo
  echo "enabled=0" | sudo tee -a /etc/yum.repos.d/CentOS-Base.repo
  echo "gpgcheck=1" | sudo tee -a /etc/yum.repos.d/CentOS-Base.repo
  echo "gpgkey=http://mirror.centos.org/centos/RPM-GPG-KEY-CentOS-6" | sudo tee -a /etc/yum.repos.d/CentOS-Base.repo

  sudo yum -y update
  sudo yum -y install --enablerepo=base ffmpeg-devel

  ##############################
  # Installing other dipendences
  ##############################
  sudo yum install -y libpng-devel libjpeg-turbo-devel jasper-devel
  sudo yum install -y tbb-devel

  if [[ ! -e "opencv-2.4.9.zip" ]]; then
    wget http://softlayer-sng.dl.sourceforge.net/project/opencvlibrary/opencv-unix/2.4.9/opencv-2.4.9.zip
  fi

  if [[ ! -e "opencv-2.4.9" ]]; then
    unzip opencv-2.4.9.zip
  fi
  cd opencv-2.4.9

  #######################
  # Applying patch to opencv-2.4.9/modules/highgui/src/cap_ffmpeg_impl.hpp
  #######################
  sed -ri '1445d' modules/highgui/src/cap_ffmpeg_impl.hpp

  if [[ ! -d "release" ]]; then
    mkdir release
  fi

  cd release
  cmake -D CMAKE_BUILD_TYPE=RELEASE -D WITH_TBB=ON -D CMAKE_INSTALL_PREFIX=/usr/local -D BUILD_PYTHON_SUPPORT=ON ..
  make -j
  sudo make install

  cd ../..

  echo "/usr/local/lib" | sudo tee /etc/ld.so.conf.d/opencv.conf

  echo "export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib" >> ~/.bash_profile
  echo "export PKG_CONFIG_PATH=$PKG_CONFIG_PATH:/usr/local/lib/pkgconfig" >> ~/.bash_profile
  echo "export PYTHONPATH=/usr/local/lib/python2.7/site-packages" >> ~/.bash_profile

  export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib
  export PKG_CONFIG_PATH=$PKG_CONFIG_PATH:/usr/local/lib/pkgconfig

  sudo mv /usr/local/lib/python2.6 /usr/local/lib/python2.7
else
  echo "OpenCV already installed."
fi

dropbox_folder=~/.dropbox-dist

if [[ ! -d "${dropbox_folder}" ]]; then
  echo "Installing Dropbox"
  wget -O - "https://www.dropbox.com/download?plat=lnx.x86_64" | tar xzf -
  wget -O dropbox.py "https://www.dropbox.com/download?dl=packages/dropbox.py"
  mv .dropbox-dist $dropbox_folder
  sudo mv dropbox.py /usr/local/bin/dropbox
  chmod +x /usr/local/bin/dropbox

  echo "Please configure Dropbox..."
  echo "Check ~/.dropbox-dist/dropbox.log for more details."

  set +e
  timeout 2s ~/.dropbox-dist/dropboxd >> ~/.dropbox-dist/dropbox.log
  set -e

  echo "Setting Dropbox at startup..."
  dropbox autostart y
fi

cd ..
rm -rf junk

echo "Setting up py-video-retargeting"

# Enable swapping
sudo /bin/dd if=/dev/zero of=/var/swap.1 bs=1M count=1024
sudo /sbin/mkswap /var/swap.1
sudo /sbin/swapon /var/swap.1

sudo pip install cython
sudo pip install py-video-retargeting
sudo pip install py-seam-merging
# sudo pip install -r requirements
# sudo python setup.py install

sudo swapoff /var/swap.1
sudo rm /var/swap.1

echo "Ready to go!"
